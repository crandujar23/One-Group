{% extends 'base.html' %}
{% block title %}Gestión de Accesos{% endblock %}
{% block content %}
<section class="hero-card p-4 mb-4 reveal">
    <h1 class="h3 mb-2">Gestión de Accesos</h1>
    <p class="mb-0 opacity-75">Crea usuarios y asigna permisos: Socio, Administrador o Asociado.</p>
</section>

<div class="row g-3 mb-4">
    <div class="col-lg-6 reveal reveal-delay-1">
        <section class="section-card p-4 h-100">
            <h2 class="h5 mb-3">Crear Usuario</h2>
            <form method="post" novalidate>
                {% csrf_token %}
                <input type="hidden" name="action" value="create">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="form-label">Usuario</label>
                        {{ create_form.username }}
                        {% for err in create_form.username.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Correo</label>
                        {{ create_form.email }}
                        {% for err in create_form.email.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Nombre</label>
                        {{ create_form.first_name }}
                        {% for err in create_form.first_name.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Apellido</label>
                        {{ create_form.last_name }}
                        {% for err in create_form.last_name.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Contraseña temporal</label>
                        {{ create_form.password }}
                        {% for err in create_form.password.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Rol</label>
                        {{ create_form.role }}
                        {% for err in create_form.role.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Unidades de negocio</label>
                        {{ create_form.business_units }}
                        {% for err in create_form.business_units.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Nivel (solo Asociado)</label>
                        {{ create_form.tier }}
                        {% for err in create_form.tier.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                    </div>
                </div>
                {% for err in create_form.non_field_errors %}<div class="text-danger small mt-2">{{ err }}</div>{% endfor %}
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Crear y asignar</button>
                </div>
            </form>
        </section>
    </div>
    <div class="col-lg-6 reveal reveal-delay-2">
        <section class="section-card p-4 h-100">
            <h2 class="h5 mb-3">Asignar Permisos</h2>
            <form method="post" novalidate>
                {% csrf_token %}
                <input type="hidden" name="action" value="assign">
                <div class="row g-3">
                    <div class="col-md-12">
                        <label class="form-label">Usuario</label>
                        {{ assign_form.user }}
                        {% for err in assign_form.user.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Rol</label>
                        {{ assign_form.role }}
                        {% for err in assign_form.role.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Unidades de negocio</label>
                        {{ assign_form.business_units }}
                        {% for err in assign_form.business_units.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                    </div>
                    <div class="col-md-6">
                        <label class="form-label">Nivel (solo Asociado)</label>
                        {{ assign_form.tier }}
                        {% for err in assign_form.tier.errors %}<div class="text-danger small">{{ err }}</div>{% endfor %}
                    </div>
                </div>
                {% for err in assign_form.non_field_errors %}<div class="text-danger small mt-2">{{ err }}</div>{% endfor %}
                <div class="mt-3">
                    <button type="submit" class="btn btn-primary">Actualizar permisos</button>
                </div>
            </form>
        </section>
    </div>
</div>

<section class="section-card p-3 reveal reveal-delay-3">
    <h2 class="h5 mb-3">Usuarios actuales</h2>
    <div class="table-responsive">
        <table class="table table-modern table-hover mb-0">
            <thead><tr><th>Usuario</th><th>Nombre</th><th>Rol</th><th>Unidad</th><th>Acciones</th></tr></thead>
            <tbody>
            {% for u in users %}
                <tr>
                    <td>{{ u.username }}</td>
                    <td>{{ u.get_full_name|default:"-" }}</td>
                    <td>{% if u.profile %}{{ u.profile.get_role_display }}{% else %}-{% endif %}</td>
                    <td>
                        {% if u.profile %}
                            {% with scoped_units=u.profile.business_units.all %}
                                {% if scoped_units %}
                                    {% for unit in scoped_units %}
                                        {{ unit.name }}{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                {% elif u.profile.business_unit %}
                                    {{ u.profile.business_unit.name }}
                                {% else %}
                                    -
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            -
                        {% endif %}
                    </td>
                    <td>
                        {% if u.id == request.user.id %}
                            <span class="text-muted small">Actual</span>
                        {% else %}
                            <form method="post" class="d-inline" onsubmit="return confirm('Esta accion eliminara el usuario. Continuar?');">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="delete">
                                <input type="hidden" name="user_id" value="{{ u.id }}">
                                <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
                            </form>
                        {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="5" class="text-center text-muted py-4">Sin usuarios.</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
</section>

{% endblock %}
